<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{fragments/header :: head(${ownerId} + ' - Dashboard')}"></head>
<body>
<div th:replace="~{fragments/header :: header}"></div>

<main class="container">
    <div class="dashboard-header">
        <h1><span th:text="${ownerId}">user</span>'s Dashboard</h1>
        <button class="btn btn-primary" onclick="openCreateModal()">+ New Schedule</button>
    </div>

    <div class="schedules-grid" th:if="${!schedules.isEmpty()}">
        <div class="schedule-card" th:each="schedule : ${schedules}">
            <div class="schedule-card-header">
                <h3 th:text="${schedule.formattedYearMonth()}">2025-12</h3>
            </div>
            <div class="schedule-card-body">
                <p>
                    <span class="participant-count" th:text="${schedule.participantCount()}">0</span>
                    participants
                </p>
            </div>
            <div class="schedule-card-actions">
                <a th:href="@{'/' + ${ownerId} + '/' + ${schedule.year()} + '/' + ${schedule.month()}}"
                   class="btn btn-secondary">View</a>
                <button class="btn btn-outline copy-link-btn"
                        th:data-owner="${ownerId}"
                        th:data-year="${schedule.year()}"
                        th:data-month="${schedule.month()}">
                    Copy Link
                </button>
                <button class="btn btn-danger delete-btn"
                        th:data-owner="${ownerId}"
                        th:data-year="${schedule.year()}"
                        th:data-month="${schedule.month()}">
                    Delete
                </button>
            </div>
        </div>
    </div>

    <div class="empty-state" th:if="${schedules.isEmpty()}">
        <p>No schedules yet. Create your first schedule!</p>
        <button class="btn btn-primary" onclick="openCreateModal()">+ New Schedule</button>
    </div>
</main>

<!-- Create Schedule Modal -->
<div id="createModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>New Schedule</h2>
            <button class="modal-close" onclick="closeCreateModal()">&times;</button>
        </div>
        <div class="modal-body">
            <form id="createScheduleForm">
                <div class="form-group">
                    <label for="year">Year</label>
                    <select id="year" name="year" required>
                        <option value="2024">2024</option>
                        <option value="2025" selected>2025</option>
                        <option value="2026">2026</option>
                        <option value="2027">2027</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="month">Month</label>
                    <select id="month" name="month" required>
                        <option th:each="m : ${#numbers.sequence(1, 12)}"
                                th:value="${m}"
                                th:text="${m + '월'}"
                                th:selected="${m == 12}">12월</option>
                    </select>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeCreateModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div th:replace="~{fragments/footer :: footer}"></div>
<th:block th:replace="~{fragments/footer :: scripts}"></th:block>

<script th:inline="javascript">
    const ownerId = [[${ownerId}]];

    function openCreateModal() {
        document.getElementById('createModal').classList.add('show');
    }

    function closeCreateModal() {
        document.getElementById('createModal').classList.remove('show');
    }

    document.getElementById('createScheduleForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        const year = parseInt(document.getElementById('year').value);
        const month = parseInt(document.getElementById('month').value);

        try {
            await api.createSchedule(ownerId, year, month);
            window.location.reload();
        } catch (error) {
            alert(error.message);
        }
    });

    function copyLink(ownerId, year, month) {
        const url = `${window.location.origin}/${ownerId}/${year}/${month}`;
        navigator.clipboard.writeText(url).then(() => {
            alert('Link copied to clipboard!');
        });
    }

    async function deleteSchedule(ownerId, year, month) {
        if (!confirm('Are you sure you want to delete this schedule?')) {
            return;
        }
        try {
            await api.deleteSchedule(ownerId, year, month);
            window.location.reload();
        } catch (error) {
            alert(error.message);
        }
    }

    document.querySelectorAll('.copy-link-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            copyLink(this.dataset.owner, this.dataset.year, this.dataset.month);
        });
    });

    document.querySelectorAll('.delete-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            deleteSchedule(this.dataset.owner, this.dataset.year, this.dataset.month);
        });
    });
</script>
</body>
</html>
