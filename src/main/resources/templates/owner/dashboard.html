<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head th:replace="~{fragments/header :: head(${seo})}"></head>
<body>
<!-- Google Tag Manager (noscript) -->
<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-PFPKQT7W"
height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
<!-- End Google Tag Manager (noscript) -->
<div th:replace="~{fragments/header :: header}"></div>

<main class="container">
    <div class="dashboard-header">
        <h1><span th:text="${ownerId}">user</span>님의 대시보드</h1>
        <button class="btn btn-primary" onclick="openCreateModal()">+ 새 일정</button>
    </div>

    <div class="schedules-grid" th:if="${!schedules.isEmpty()}">
        <div class="schedule-card" th:each="schedule : ${schedules}">
            <div class="schedule-card-header">
                <h3 th:text="${schedule.formattedYearMonth()}">2025-12</h3>
            </div>
            <div class="schedule-card-body">
                <p>
                    <span class="participant-count" th:text="${schedule.participantCount()}">0</span>
                    명 참여
                </p>
            </div>
            <div class="schedule-card-actions">
                <a th:href="@{'/' + ${ownerId} + '/' + ${schedule.year()} + '/' + ${schedule.month()}}"
                   class="btn btn-secondary">보기</a>
                <button class="btn btn-outline copy-link-btn"
                        th:data-owner="${ownerId}"
                        th:data-year="${schedule.year()}"
                        th:data-month="${schedule.month()}">
                    링크 복사
                </button>
                <button class="btn btn-danger delete-btn"
                        th:data-owner="${ownerId}"
                        th:data-year="${schedule.year()}"
                        th:data-month="${schedule.month()}">
                    삭제
                </button>
            </div>
        </div>
    </div>

    <div class="empty-state" th:if="${schedules.isEmpty()}">
        <p>아직 일정이 없습니다. 첫 번째 일정을 만들어보세요!</p>
        <button class="btn btn-primary" onclick="openCreateModal()">+ 새 일정</button>
    </div>
</main>

<!-- Create Schedule Modal -->
<div id="createModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>새 일정</h2>
            <button class="modal-close" onclick="closeCreateModal()">&times;</button>
        </div>
        <div class="modal-body">
            <form id="createScheduleForm">
                <div class="form-group">
                    <label for="year">연도</label>
                    <select id="year" name="year" required>
                        <option value="2024">2024</option>
                        <option value="2025" selected>2025</option>
                        <option value="2026">2026</option>
                        <option value="2027">2027</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="month">월</label>
                    <select id="month" name="month" required>
                        <option th:each="m : ${#numbers.sequence(1, 12)}"
                                th:value="${m}"
                                th:text="${m + '월'}"
                                th:selected="${m == 12}">12월</option>
                    </select>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeCreateModal()">취소</button>
                    <button type="submit" class="btn btn-primary">만들기</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div th:replace="~{fragments/footer :: footer}"></div>
<th:block th:replace="~{fragments/footer :: scripts}"></th:block>

<script th:inline="javascript">
    const ownerId = [[${ownerId}]];

    function openCreateModal() {
        document.getElementById('createModal').classList.add('show');
    }

    function closeCreateModal() {
        document.getElementById('createModal').classList.remove('show');
    }

    document.getElementById('createScheduleForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        const year = parseInt(document.getElementById('year').value);
        const month = parseInt(document.getElementById('month').value);

        try {
            await api.createSchedule(ownerId, year, month);
            window.location.reload();
        } catch (error) {
            toast.error(error.message);
        }
    });

    function copyLink(ownerId, year, month) {
        const url = `${window.location.origin}/${ownerId}/${year}/${month}`;

        if (navigator.clipboard && window.isSecureContext) {
            navigator.clipboard.writeText(url)
                .then(() => alert('링크가 클립보드에 복사되었습니다!'))
                .catch(() => fallbackCopy(url));
        } else {
            fallbackCopy(url);
        }
    }

    function fallbackCopy(text) {
        const textarea = document.createElement('textarea');
        textarea.value = text;
        textarea.style.position = 'fixed';
        textarea.style.opacity = '0';
        document.body.appendChild(textarea);
        textarea.select();
        try {
            document.execCommand('copy');
            alert('링크가 클립보드에 복사되었습니다!');
        } catch (err) {
            prompt('아래 링크를 복사하세요:', text);
        }
        document.body.removeChild(textarea);
    }

    async function deleteSchedule(ownerId, year, month) {
        if (!confirm('이 일정을 삭제하시겠습니까?')) {
            return;
        }
        try {
            await api.deleteSchedule(ownerId, year, month);
            window.location.reload();
        } catch (error) {
            toast.error(error.message);
        }
    }

    document.querySelectorAll('.copy-link-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            copyLink(this.dataset.owner, this.dataset.year, this.dataset.month);
        });
    });

    document.querySelectorAll('.delete-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            deleteSchedule(this.dataset.owner, this.dataset.year, this.dataset.month);
        });
    });
</script>
</body>
</html>
