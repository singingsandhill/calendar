<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head th:replace="~{fragments/header :: head(${seo})}"></head>
<body>
<!-- Google Tag Manager (noscript) -->
<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-PFPKQT7W"
height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
<!-- End Google Tag Manager (noscript) -->
<div th:replace="~{fragments/header :: [th:fragment='header']}"></div>

<main class="container">
    <div class="schedule-header">
        <p class="owner-info"><span th:text="${ownerId}">user</span>ë‹˜ì˜ ì¼ì •</p>
        <h1 th:text="${year + 'ë…„ ' + month + 'ì›”'}">2025ë…„ 12ì›”</h1>
        <p class="subtitle">ì°¸ì—¬ ê°€ëŠ¥í•œ ë‚ ì§œë¥¼ ì„ íƒí•˜ì„¸ìš”</p>
        <button class="btn btn-outline copy-link-btn" onclick="copyLink()">ë§í¬ ë³µì‚¬</button>
    </div>

    <div class="participant-section">
        <div class="participant-selector">
            <label for="participantSelect">ì´ë¦„ ì„ íƒ:</label>
            <select id="participantSelect" onchange="onParticipantChange()">
                <option value="">-- ì´ë¦„ ì„ íƒ --</option>
                <option th:each="p : ${schedule.participants()}"
                        th:value="${p.id()}"
                        th:text="${p.name()}"
                        th:data-color="${p.color()}">Participant</option>
            </select>
            <button class="btn btn-outline btn-sm" onclick="openAddParticipantModal()">+ ì¶”ê°€</button>
        </div>

        <div class="participant-legend">
            <span class="legend-item" th:each="p : ${schedule.participants()}">
                <span class="color-dot" th:style="'background-color: ' + ${p.color()}"></span>
                <span th:text="${p.name()}">Name</span>
            </span>
        </div>
    </div>

    <div class="calendar-container">
        <div class="calendar">
            <div class="calendar-header">
                <div class="weekday">ì¼</div>
                <div class="weekday">ì›”</div>
                <div class="weekday">í™”</div>
                <div class="weekday">ìˆ˜</div>
                <div class="weekday">ëª©</div>
                <div class="weekday">ê¸ˆ</div>
                <div class="weekday">í† </div>
            </div>
            <div class="calendar-body" id="calendarBody">
                <!-- Calendar days will be generated by JavaScript -->
            </div>
        </div>
    </div>

    <div class="action-buttons">
        <button class="btn btn-secondary" onclick="resetSelections()">ì´ˆê¸°í™”</button>
        <button class="btn btn-primary" onclick="saveSelections()">ì €ì¥</button>
    </div>

    <!-- Location Voting Section -->
    <div class="location-section">
        <h3>ì¥ì†Œ íˆ¬í‘œ</h3>
        <div class="location-add">
            <input type="text" id="locationInput" placeholder="ì¥ì†Œ ì…ë ¥" maxlength="100">
            <button class="btn btn-outline btn-sm" onclick="addLocation()">ì¶”ê°€</button>
        </div>
        <div class="location-list" id="locationList">
            <div class="location-item" th:each="loc : ${schedule.locations()}">
                <div class="location-info">
                    <span class="location-name" th:text="${loc.name()}">ì¥ì†Œëª…</span>
                    <span class="location-votes" th:text="${loc.voteCount() + 'í‘œ'}">0í‘œ</span>
                </div>
                <div class="location-voters">
                    <span class="voter-tag" th:each="voter : ${loc.voters()}" th:text="${voter}">íˆ¬í‘œì</span>
                </div>
                <div class="location-actions">
                    <button class="btn btn-sm btn-primary vote-btn"
                            th:data-location-id="${loc.id()}"
                            onclick="toggleVote(this)">íˆ¬í‘œ</button>
                </div>
            </div>
            <p th:if="${schedule.locations().isEmpty()}" class="empty-locations">ì•„ì§ ì œì•ˆëœ ì¥ì†Œê°€ ì—†ìŠµë‹ˆë‹¤.</p>
        </div>
    </div>

    <!-- Menu Voting Section -->
    <div class="location-section">
        <h3>ë©”ë‰´ íˆ¬í‘œ</h3>
        <div class="location-add">
            <input type="text" id="menuInput" placeholder="ë©”ë‰´ ì…ë ¥" maxlength="100">
            <input type="url" id="menuUrlInput" placeholder="URL (ì„ íƒì‚¬í•­)" maxlength="500">
            <button class="btn btn-outline btn-sm" onclick="addMenu()">ì¶”ê°€</button>
        </div>
        <div class="location-list" id="menuList">
            <div class="location-item" th:each="menu : ${schedule.menus()}">
                <div class="location-info">
                    <span class="location-name" th:text="${menu.name()}">ë©”ë‰´ëª…</span>
                    <a th:if="${menu.url() != null and !menu.url().isEmpty()}"
                       th:href="${menu.url()}"
                       target="_blank"
                       rel="noopener noreferrer"
                       class="menu-link">ğŸ”—</a>
                    <span class="location-votes" th:text="${menu.voteCount() + 'í‘œ'}">0í‘œ</span>
                </div>
                <div class="location-voters">
                    <span class="voter-tag" th:each="voter : ${menu.voters()}" th:text="${voter}">íˆ¬í‘œì</span>
                </div>
                <div class="location-actions">
                    <button class="btn btn-sm btn-primary menu-vote-btn"
                            th:data-menu-id="${menu.id()}"
                            onclick="toggleMenuVote(this)">íˆ¬í‘œ</button>
                </div>
            </div>
            <p th:if="${schedule.menus().isEmpty()}" class="empty-locations">ì•„ì§ ì œì•ˆëœ ë©”ë‰´ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
        </div>
    </div>
</main>

<!-- Add Participant Modal -->
<div id="addParticipantModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="addParticipantModalTitle">
    <div class="modal-content modal-sm">
        <div class="modal-header">
            <h2 id="addParticipantModalTitle">ì°¸ì—¬ì ì¶”ê°€</h2>
            <button class="modal-close" onclick="closeAddParticipantModal()">&times;</button>
        </div>
        <div class="modal-body">
            <form id="addParticipantForm">
                <div class="form-group">
                    <label for="participantName">ì´ë¦„</label>
                    <input type="text" id="participantName" name="name"
                           maxlength="10" required placeholder="ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”">
                </div>
                <p class="participant-count-info">
                    <span th:text="${schedule.participants().size()}">0</span> / 8ëª…
                </p>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeAddParticipantModal()">ì·¨ì†Œ</button>
                    <button type="submit" class="btn btn-primary"
                            th:disabled="${schedule.participants().size() >= 8}">ì¶”ê°€</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div th:replace="~{fragments/footer :: [th:fragment='footer']}"></div>
<th:block th:replace="~{fragments/footer :: scripts}"></th:block>

<!-- Schedule data injection for external script -->
<script th:inline="javascript">
    window.SCHEDULE_DATA = {
        scheduleId: [[${schedule.id()}]],
        ownerId: [[${ownerId}]],
        year: [[${schedule.year()}]],
        month: [[${schedule.month()}]],
        daysInMonth: [[${schedule.daysInMonth()}]],
        firstDayOfWeek: [[${schedule.firstDayOfWeek()}]],
        totalDays: [[${schedule.totalDays()}]],
        isExtendedMode: [[${schedule.isExtendedMode()}]],
        participants: [
            [# th:each="p, stat : ${schedule.participants()}"]
            {
                id: [[${p.id()}]],
                name: [[${p.name()}]],
                color: [[${p.color()}]],
                selections: [[${p.selections()}]]
            }[# th:unless="${stat.last}"],[/]
            [/]
        ],
        locations: [
            [# th:each="loc, stat : ${schedule.locations()}"]
            {
                id: [[${loc.id()}]],
                name: [[${loc.name()}]],
                voters: [[${loc.voters()}]],
                voteCount: [[${loc.voteCount()}]]
            }[# th:unless="${stat.last}"],[/]
            [/]
        ],
        menus: [
            [# th:each="menu, stat : ${schedule.menus()}"]
            {
                id: [[${menu.id()}]],
                name: [[${menu.name()}]],
                url: [[${menu.url()}]],
                voters: [[${menu.voters()}]],
                voteCount: [[${menu.voteCount()}]]
            }[# th:unless="${stat.last}"],[/]
            [/]
        ]
    };
</script>
<script defer th:src="@{/js/schedule-view.js}"></script>
</body>
</html>
