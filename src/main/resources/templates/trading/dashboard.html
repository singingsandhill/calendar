<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head th:replace="~{trading/fragments/header :: header}"></head>
<body class="bg-gray-100 dark:bg-gray-900 min-h-screen">

<nav th:replace="~{trading/fragments/header :: navbar}"></nav>

<main class="container mx-auto px-4 py-6">
    <!-- Stats Grid -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
        <!-- Total Value -->
        <div class="card">
            <div class="stat-label">Total Value</div>
            <div class="stat-value" id="total-value">
                <span th:text="${#numbers.formatDecimal(profitSummary.totalValue(), 0, 0)}">0</span> KRW
            </div>
        </div>

        <!-- Unrealized P&L -->
        <div class="card">
            <div class="stat-label">Unrealized P&L</div>
            <div class="stat-value" id="unrealized-pnl"
                 th:classappend="${profitSummary.unrealizedPnl().compareTo(T(java.math.BigDecimal).ZERO) >= 0} ? 'positive' : 'negative'">
                <span th:text="${#numbers.formatDecimal(profitSummary.unrealizedPnlPct(), 1, 2)}">0</span>%
            </div>
        </div>

        <!-- Win Rate -->
        <div class="card">
            <div class="stat-label">Win Rate</div>
            <div class="stat-value">
                <span th:text="${#numbers.formatDecimal(profitSummary.winRate(), 1, 1)}">0</span>%
            </div>
            <div class="text-sm text-gray-500">
                <span th:text="${profitSummary.totalTrades()}">0</span> trades
            </div>
        </div>

        <!-- Bot Status -->
        <div class="card">
            <div class="stat-label">Bot Status</div>
            <div class="flex items-center space-x-2 mt-2">
                <span class="w-4 h-4 rounded-full"
                      th:classappend="${botStatus.running()} ? (${botStatus.paused()} ? 'bg-yellow-500' : 'bg-green-500') : 'bg-red-500'"></span>
                <span class="font-medium"
                      th:text="${botStatus.running()} ? (${botStatus.paused()} ? 'Paused' : 'Running') : 'Stopped'">Stopped</span>
            </div>
            <div class="mt-3 flex space-x-2">
                <button onclick="toggleBot()" class="btn-primary text-sm" id="toggle-btn">
                    <span th:text="${botStatus.running()} ? 'Stop' : 'Start'">Start</span>
                </button>
                <button onclick="emergencyClose()" class="btn-danger text-sm">Emergency</button>
            </div>
        </div>
    </div>

    <!-- Chart Section -->
    <div class="card mb-6">
        <div class="flex items-center justify-between mb-4">
            <h2 class="text-lg font-semibold dark:text-white">Price Chart - <span th:text="${market}">KRW-ADA</span></h2>
            <div class="flex items-center space-x-4">
                <span class="text-2xl font-bold dark:text-white" id="current-price">Loading...</span>
            </div>
        </div>
        <div id="chart-container" style="height: 400px;"></div>
    </div>

    <!-- Indicators & Positions -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Indicators -->
        <div class="card">
            <h3 class="text-lg font-semibold mb-4 dark:text-white">Technical Indicators</h3>
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <div class="stat-label">RSI (14)</div>
                    <div class="stat-value text-lg" id="indicator-rsi">-</div>
                </div>
                <div>
                    <div class="stat-label">Stochastic K/D</div>
                    <div class="stat-value text-lg" id="indicator-stoch">-</div>
                </div>
                <div>
                    <div class="stat-label">MA5</div>
                    <div class="stat-value text-lg" id="indicator-ma5">-</div>
                </div>
                <div>
                    <div class="stat-label">MA20</div>
                    <div class="stat-value text-lg" id="indicator-ma20">-</div>
                </div>
            </div>
        </div>

        <!-- Recent Positions -->
        <div class="card">
            <h3 class="text-lg font-semibold mb-4 dark:text-white">Recent Positions</h3>
            <div class="overflow-x-auto">
                <table class="w-full text-sm">
                    <thead class="text-gray-500">
                        <tr>
                            <th class="text-left py-2">Entry</th>
                            <th class="text-left py-2">Exit</th>
                            <th class="text-right py-2">P&L</th>
                            <th class="text-left py-2">Reason</th>
                        </tr>
                    </thead>
                    <tbody id="positions-table" class="dark:text-gray-300">
                        <tr><td colspan="4" class="text-center py-4">Loading...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</main>

<script th:inline="javascript">
    let chart;
    let candleSeries;
    let ma5Line, ma20Line, ma60Line;

    // Initialize chart
    function initChart() {
        const container = document.getElementById('chart-container');
        chart = LightweightCharts.createChart(container, {
            layout: {
                background: { type: 'solid', color: '#1f2937' },
                textColor: '#d1d5db',
            },
            grid: {
                vertLines: { color: '#374151' },
                horzLines: { color: '#374151' },
            },
            crosshair: {
                mode: LightweightCharts.CrosshairMode.Normal,
            },
            rightPriceScale: {
                borderColor: '#374151',
            },
            timeScale: {
                borderColor: '#374151',
                timeVisible: true,
                secondsVisible: false,
            },
        });

        candleSeries = chart.addCandlestickSeries({
            upColor: '#22c55e',
            downColor: '#ef4444',
            borderDownColor: '#ef4444',
            borderUpColor: '#22c55e',
            wickDownColor: '#ef4444',
            wickUpColor: '#22c55e',
        });

        ma5Line = chart.addLineSeries({ color: '#3b82f6', lineWidth: 1, title: 'MA5' });
        ma20Line = chart.addLineSeries({ color: '#f59e0b', lineWidth: 1, title: 'MA20' });
        ma60Line = chart.addLineSeries({ color: '#8b5cf6', lineWidth: 1, title: 'MA60' });

        loadChartData();
    }

    // Load chart data
    async function loadChartData() {
        try {
            const response = await fetch('/api/trading/candles?count=200');
            const data = await response.json();

            if (data.candles && data.candles.length > 0) {
                const candleData = data.candles.map(c => ({
                    time: new Date(c.time).getTime() / 1000,
                    open: c.open,
                    high: c.high,
                    low: c.low,
                    close: c.close,
                })).reverse();

                candleSeries.setData(candleData);

                // Update current price
                const lastCandle = candleData[candleData.length - 1];
                document.getElementById('current-price').textContent =
                    lastCandle.close.toLocaleString() + ' KRW';

                // Load trade markers after candles
                await loadTradeMarkers();
            }
        } catch (error) {
            console.error('Failed to load chart data:', error);
        }
    }

    // Load trade markers for chart
    async function loadTradeMarkers() {
        try {
            const response = await fetch('/api/trading/chart/trades?minutes=200');
            const trades = await response.json();

            if (trades && trades.length > 0) {
                const markers = trades.map(t => ({
                    time: new Date(t.time).getTime() / 1000,
                    position: t.type === 'BUY' ? 'belowBar' : 'aboveBar',
                    color: t.type === 'BUY' ? '#22c55e' : '#ef4444',
                    shape: t.type === 'BUY' ? 'arrowUp' : 'arrowDown',
                    text: t.type + ' ' + t.price.toLocaleString()
                }));

                candleSeries.setMarkers(markers);
            }
        } catch (error) {
            console.error('Failed to load trade markers:', error);
        }
    }

    // Load indicators
    async function loadIndicators() {
        try {
            const response = await fetch('/api/trading/ticker');
            const data = await response.json();

            document.getElementById('indicator-rsi').textContent =
                data.rsi ? data.rsi.toFixed(2) : '-';
            document.getElementById('indicator-stoch').textContent =
                data.stochK && data.stochD ?
                    data.stochK.toFixed(1) + ' / ' + data.stochD.toFixed(1) : '-';
            document.getElementById('indicator-ma5').textContent =
                data.ma5 ? data.ma5.toLocaleString() : '-';
            document.getElementById('indicator-ma20').textContent =
                data.ma20 ? data.ma20.toLocaleString() : '-';

            if (data.currentPrice) {
                document.getElementById('current-price').textContent =
                    data.currentPrice.toLocaleString() + ' KRW';
            }
        } catch (error) {
            console.error('Failed to load indicators:', error);
        }
    }

    // Load positions
    async function loadPositions() {
        try {
            const response = await fetch('/api/trading/positions?size=5');
            const positions = await response.json();

            const tbody = document.getElementById('positions-table');
            if (positions.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="text-center py-4 text-gray-500">No positions</td></tr>';
                return;
            }

            tbody.innerHTML = positions.map(p => `
                <tr class="border-t border-gray-700">
                    <td class="py-2">${p.entryPrice ? p.entryPrice.toLocaleString() : '-'}</td>
                    <td class="py-2">${p.exitPrice ? p.exitPrice.toLocaleString() : '-'}</td>
                    <td class="py-2 text-right ${p.realizedPnlPct >= 0 ? 'positive' : 'negative'}">
                        ${p.realizedPnlPct ? p.realizedPnlPct.toFixed(2) + '%' : '-'}
                    </td>
                    <td class="py-2">${p.closeReason || p.status}</td>
                </tr>
            `).join('');
        } catch (error) {
            console.error('Failed to load positions:', error);
        }
    }

    // Bot control
    async function toggleBot() {
        const response = await fetch('/api/trading/bot/status');
        const status = await response.json();

        const endpoint = status.running ? '/api/trading/bot/stop' : '/api/trading/bot/start';
        await fetch(endpoint, { method: 'POST' });
        location.reload();
    }

    async function emergencyClose() {
        if (confirm('Are you sure you want to execute emergency close?')) {
            await fetch('/api/trading/bot/emergency-close', { method: 'POST' });
            location.reload();
        }
    }

    // Update bot status
    async function updateBotStatus() {
        try {
            const response = await fetch('/api/trading/bot/status');
            const status = await response.json();

            const dot = document.getElementById('status-dot');
            const text = document.getElementById('status-text');
            const btn = document.getElementById('toggle-btn');

            if (status.running) {
                dot.className = status.paused ? 'w-3 h-3 rounded-full bg-yellow-500' : 'w-3 h-3 rounded-full bg-green-500';
                text.textContent = status.paused ? 'Paused' : 'Running';
                btn.textContent = 'Stop';
            } else {
                dot.className = 'w-3 h-3 rounded-full bg-red-500';
                text.textContent = 'Stopped';
                btn.textContent = 'Start';
            }
        } catch (error) {
            console.error('Failed to update bot status:', error);
        }
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
        initChart();
        loadIndicators();
        loadPositions();

        // Auto-refresh
        setInterval(loadIndicators, 10000);
        setInterval(updateBotStatus, 5000);
        setInterval(loadTradeMarkers, 30000);  // Refresh trade markers every 30 seconds
    });

    // Handle window resize
    window.addEventListener('resize', () => {
        if (chart) {
            chart.applyOptions({ width: document.getElementById('chart-container').clientWidth });
        }
    });
</script>

</body>
</html>
