<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security" lang="ko">
<head th:replace="~{runners/fragments/header :: head(${seo})}"></head>
<body class="runners-body">
    <nav th:replace="~{runners/fragments/header :: navbar}"></nav>

    <main class="runners-container">
        <section class="runners-run-detail">
            <!-- Run Detail Header -->
            <div class="runners-run-detail-header">
                <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                    <div>
                        <span class="runners-run-category"
                              th:classappend="${run.category() == 'REGULAR' ? 'regular' : 'lightning'}"
                              th:text="${run.categoryDisplayName()}">정규런</span>
                        <h1 th:text="${run.formattedDate()}">2024년 12월 15일 (일)</h1>
                    </div>
                    <a th:href="@{/runners/runs}" class="runners-btn runners-btn-secondary">
                        ← 목록으로
                    </a>
                </div>
                <div class="runners-run-detail-info">
                    <div class="runners-run-detail-info-item">
                        <span class="label">시간</span>
                        <span class="value" th:text="${run.formattedTime()}">09:00</span>
                    </div>
                    <div class="runners-run-detail-info-item">
                        <span class="label">장소</span>
                        <span class="value" th:text="${run.location()}">잠실 종합운동장</span>
                    </div>
                </div>
            </div>

            <!-- Attendance Section -->
            <div class="runners-attendance">
                <!-- Attendance Form -->
                <div class="runners-attendance-form-card">
                    <h2>출석 등록</h2>
                    <form id="attendanceForm">
                        <div class="runners-form-group">
                            <label for="participantName">이름</label>
                            <input type="text" id="participantName" name="participantName"
                                   class="runners-input" placeholder="이름을 입력하세요" required maxlength="50">
                        </div>
                        <div class="runners-form-group">
                            <label for="distance">달린 거리 (km)</label>
                            <input type="number" id="distance" name="distance"
                                   class="runners-input" placeholder="5.0" required
                                   min="0.1" max="100" step="0.1">
                        </div>
                        <button type="submit" class="runners-btn runners-btn-primary" style="width: 100%;">
                            출석 등록
                        </button>
                    </form>
                    <div id="formMessage" class="runners-message" style="display: none; margin-top: 1rem;"></div>
                </div>

                <!-- Attendance List -->
                <div class="runners-attendance-list-card">
                    <h2>출석 현황 (<span id="attendanceCount" th:text="${attendances.size()}">0</span>명)</h2>
                    <ul class="runners-attendance-list" id="attendanceList">
                        <li class="runners-attendance-item" th:each="attendance : ${attendances}" th:data-id="${attendance.id()}">
                            <span class="runners-attendance-name" th:text="${attendance.participantName()}">러너</span>
                            <span class="runners-attendance-distance" th:text="${attendance.distance()} + 'km'">5.0km</span>
                            <button sec:authorize="hasRole('ADMIN')"
                                    class="runners-delete-btn"
                                    th:data-id="${attendance.id()}"
                                    th:data-name="${attendance.participantName()}"
                                    type="button"
                                    title="삭제">×</button>
                        </li>
                    </ul>
                    <div class="runners-empty" th:if="${attendances.isEmpty()}" id="emptyState">
                        <p>아직 출석한 러너가 없습니다</p>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- Delete Confirmation Modal -->
    <div id="deleteModal" class="runners-modal" role="dialog" aria-modal="true" aria-labelledby="deleteModalTitle" sec:authorize="hasRole('ADMIN')">
        <div class="runners-modal-content">
            <h3 id="deleteModalTitle">출석 삭제</h3>
            <p><span id="deleteName"></span>님의 출석 기록을 정말 삭제하시겠습니까?</p>
            <div class="runners-modal-buttons">
                <button id="cancelDelete" class="runners-btn runners-btn-secondary" type="button">취소</button>
                <button id="confirmDelete" class="runners-btn runners-btn-danger" type="button">삭제</button>
            </div>
        </div>
    </div>

    <footer th:replace="~{runners/fragments/footer :: footer}"></footer>

    <!-- Run data injection for external script -->
    <script th:inline="javascript">
        window.RUN_DATA = { runId: [[${run.id()}]] };
    </script>
    <script defer th:src="@{/js/run-detail.js}"></script>
</body>
</html>
